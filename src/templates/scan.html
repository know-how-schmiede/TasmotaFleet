{% extends "base.html" %}

{% block title %}TasmotaFleet | Scan{% endblock %}

{% block content %}
{% set stats = scan_state.get('stats', {}) %}
{% set current_range = default_range if scan_state.get('status') != 'running' else scan_state.get('range', default_range) %}
{% set ports = stats.get('ports', [80, 443]) %}
{% set status = scan_state.get('status', 'idle') %}
{% set progress_raw = scan_state.get('progress', {'done': 0, 'total': 0, 'last_ip': None}) %}
{% set progress_active = status == 'running' or (status == 'done' and progress_raw.done and progress_raw.total) %}
{% if progress_active %}
  {% set progress = progress_raw %}
{% else %}
  {% set progress = {'done': 0, 'total': 0, 'last_ip': None} %}
{% endif %}
{% set percent = (progress.done / progress.total * 100) if progress_active and progress.total else 0 %}
{% set last_error = scan_state.get('last_error') %}

<div class="row g-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
          <div>
            <h1 class="h4 mb-1">Netzwerk-Scan</h1>
            <p class="text-muted mb-0">
              Konfiguriere den IP-Range und Ports und starte den Scan. Fortschritt wird live angezeigt.
            </p>
          </div>
          <div class="text-lg-end">
            <div id="lastScanTime" class="badge text-bg-secondary text-wrap">
              Letzter Scan:
              {% if stats.get('started_at') %}
                {{ stats.get('started_at').strftime('%d.%m.%Y %H:%M:%S') }}
              {% else %}
                noch keiner
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="row g-4">
      <div class="col-lg-4">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-body-secondary d-flex align-items-center justify-content-between">
            <div class="fw-semibold">Scan-Status</div>
            <span id="scanStatusPill" class="badge text-bg-secondary text-uppercase">
              {{ status }}
            </span>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <div class="d-flex justify-content-between small text-muted mb-1">
                <span>Fortschritt</span>
                <span id="scanProgressText">{{ progress.done }}/{{ progress.total }} ({{ percent|round|int }}%)</span>
              </div>
              <div class="progress" role="progressbar" aria-label="Scan Fortschritt" aria-valuenow="{{ percent|round|int }}" aria-valuemin="0" aria-valuemax="100">
                <div id="scanProgressBarFill" class="progress-bar progress-bar-striped {% if status == 'running' %}progress-bar-animated{% endif %}"
                     style="width: {{ percent }}%"></div>
              </div>
              <div class="small text-muted mt-1" id="scanLastIp">
                {% if progress.last_ip %}Letzte IP: {{ progress.last_ip }}{% else %}&nbsp;{% endif %}
              </div>
            </div>

            {% if last_error %}
              <div id="scanErrorMessage" class="alert alert-danger py-2 mb-3">
                {{ last_error }}
              </div>
            {% else %}
              <div id="scanErrorMessage" class="d-none"></div>
            {% endif %}

            <dl class="row mb-0">
              <dt class="col-6 text-muted small">Range</dt>
              <dd class="col-6 small">{{ current_range }}</dd>

              <dt class="col-6 text-muted small">Hosts gesamt</dt>
              <dd class="col-6 small" id="scanHostsTotal">{{ stats.get('hosts_total', 0) }}</dd>

              <dt class="col-6 text-muted small">Ports</dt>
              <dd class="col-6 small">{{ ports | join(', ') }}</dd>

              <dt class="col-6 text-muted small">Dauer</dt>
              <dd class="col-6 small" id="scanDuration">
                {% if stats.get('duration') %}
                  {{ "%.2f" | format(stats.get('duration')) }} s
                {% else %}
                  -
                {% endif %}
              </dd>

              <dt class="col-6 text-muted small">Gefundene Geraete</dt>
              <dd class="col-6 small" id="scanDevicesCount">{{ scan_state.get('devices', []) | length }}</dd>
            </dl>
          </div>
        </div>
      </div>
      <div class="col-lg-8">
        <form id="scanForm" action="{{ url_for('scan_page') }}" method="post" class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column gap-3">
            <div>
              <label for="ip_range" class="form-label fw-semibold">IP-Range</label>
              <input type="text"
                     class="form-control form-control-lg"
                     id="ip_range"
                     name="ip_range"
                     value="{{ current_range }}"
                     placeholder="z.B. 192.168.0.0/24 oder 192.168.0.10-192.168.0.50">
              <div class="form-text">
                Unterstuetzt CIDR oder Start-Ende. Standard: lokales /24 Netz.
              </div>
            </div>

            <div>
              <div class="form-label fw-semibold">Ports</div>
              <div class="d-flex flex-wrap gap-3">
                {% for port in [80, 443] %}
                  <div class="form-check">
                    <input class="form-check-input"
                           type="checkbox"
                           value="{{ port }}"
                           id="port{{ port }}"
                           name="ports"
                           {% if port in ports %}checked{% endif %}>
                    <label class="form-check-label" for="port{{ port }}">Port {{ port }}</label>
                  </div>
                {% endfor %}
              </div>
              <div class="form-text">Port 80 = HTTP, Port 443 = HTTPS.</div>
            </div>

            <div class="text-end mt-auto">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-broadcast-pin me-1"></i> Scan starten
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script>
    (function() {
      const statusUrl = "{{ url_for('scan_status') }}";
      const statusPill = document.getElementById('scanStatusPill');
      const barFill = document.getElementById('scanProgressBarFill');
      const progressText = document.getElementById('scanProgressText');
      const lastIpEl = document.getElementById('scanLastIp');
      const errorBox = document.getElementById('scanErrorMessage');
      const hostsEl = document.getElementById('scanHostsTotal');
      const durationEl = document.getElementById('scanDuration');
      const devicesCountEl = document.getElementById('scanDevicesCount');
      const lastScanEl = document.getElementById('lastScanTime');
      const initialStatus = "{{ status }}";

      function formatPercent(done, total) {
        if (!total || total <= 0) return 0;
        return Math.min(100, Math.round((done / total) * 100));
      }

      function setStatusBadge(state) {
        if (!statusPill) return;
        statusPill.textContent = state;
        statusPill.className = 'badge text-uppercase';
        const map = {
          running: 'text-bg-warning',
          done: 'text-bg-success',
          error: 'text-bg-danger',
          idle: 'text-bg-secondary',
        };
        statusPill.classList.add(map[state] || 'text-bg-secondary');
      }

      function setProgress(done, total, state, lastIp) {
        if (!barFill || !progressText) return;
        const isRunning = state === 'running';
        const hasFinishedProgress = state === 'done' && total > 0 && done > 0;
        const showProgress = isRunning || hasFinishedProgress;
        const pct = showProgress ? formatPercent(done, total) : 0;
        const shownDone = showProgress ? done : 0;
        const shownTotal = showProgress ? total : 0;
        barFill.style.width = pct + '%';
        barFill.setAttribute('aria-valuenow', pct);
        barFill.classList.toggle('progress-bar-animated', isRunning);
        progressText.textContent = `${shownDone}/${shownTotal} (${pct}%)`;
        if (lastIpEl) {
          if (isRunning && lastIp) {
            lastIpEl.textContent = `Letzte IP: ${lastIp}`;
          } else {
            lastIpEl.innerHTML = '&nbsp;';
          }
        }
      }

      function updateStats(stats, devicesCount) {
        if (hostsEl) hostsEl.textContent = stats.hosts_total ?? 0;
        if (durationEl) {
          const dur = stats.duration;
          durationEl.textContent = dur ? `${Number(dur).toFixed(2)} s` : '-';
        }
        if (devicesCountEl) devicesCountEl.textContent = devicesCount ?? 0;
        if (lastScanEl) {
          if (stats.started_at) {
            const dt = new Date(stats.started_at);
            lastScanEl.textContent = `Letzter Scan: ${dt.toLocaleString()}`;
          } else {
            lastScanEl.textContent = 'Letzter Scan: noch keiner';
          }
        }
      }

      function setError(message) {
        if (!errorBox) return;
        if (message) {
          errorBox.className = 'alert alert-danger py-2 mb-3';
          errorBox.textContent = message;
        } else {
          errorBox.className = 'd-none';
          errorBox.textContent = '';
        }
      }

      function poll() {
        fetch(statusUrl)
          .then((resp) => resp.json())
          .then((data) => {
            const state = data.status || 'idle';
            const prog = data.progress || { done: 0, total: 0, last_ip: null };
            setStatusBadge(state);
            setProgress(prog.done || 0, prog.total || 0, state, prog.last_ip);
            setError(data.last_error);
            updateStats(data.stats || {}, data.devices_found || 0);

            if (state === 'running') {
              setTimeout(poll, 1000);
            } else {
              setTimeout(poll, 3000);
            }
          })
          .catch(() => {
            setTimeout(poll, 3000);
          });
      }

      setStatusBadge(initialStatus);
      setTimeout(poll, 200);
    })();
  </script>
{% endblock %}
