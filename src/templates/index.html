{% extends "base.html" %}

{% block title %}TasmotaFleet | Dashboard{% endblock %}

{% block content %}
{% set stats = scan_state.get('stats', {}) %}
{% set devices = scan_state.get('devices', []) %}

<div class="row g-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
          <div>
            <h1 class="h4 mb-1">TasmotaFleet Dashboard</h1>
            <p class="text-muted mb-0">
              Übersicht der gefundenen Tasmota-Geraete. Scans kannst du im Menü unter "Scan" starten.
            </p>
          </div>
          <div class="text-lg-end">
            <div id="lastScanTime" class="badge text-bg-secondary text-wrap">
              Letzter Scan:
              {% if stats.get('started_at') %}
                {{ stats.get('started_at').strftime('%d.%m.%Y %H:%M:%S') }}
              {% else %}
                noch keiner
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-body-secondary d-flex align-items-center justify-content-between">
        <div class="fw-semibold">Gefundene Tasmota-Geraete</div>
        <span class="badge text-bg-primary" id="devicesCountBadge">{{ devices | length }}</span>
      </div>
      <div class="card-body">
        <div class="table-responsive" id="devicesTableWrapper" {% if not devices %}style="display:none;"{% endif %}>
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>IP / Port</th>
                <th>Version</th>
                <th>MAC</th>
                <th>RSSI</th>
                <th>Power</th>
                <th>Web-UI</th>
              </tr>
            </thead>
            <tbody id="devicesTableBody">
              {% for dev in devices %}
                <tr>
                  <td>
                    <div class="fw-semibold">{{ dev.name }}</div>
                    <div class="text-muted small">
                      {{ dev.hostname or dev.device_name or 'Hostname unbekannt' }}
                    </div>
                  </td>
                  <td>
                    <a href="{{ dev.url }}" target="_blank" rel="noreferrer" class="link-underline link-underline-opacity-0">
                      {{ dev.ip }}:{{ dev.port }} ({{ dev.protocol | upper }})
                    </a>
                  </td>
                  <td>{{ dev.version or '-' }}</td>
                  <td class="text-monospace small">{{ dev.mac or '-' }}</td>
                  <td>
                    {% if dev.rssi is not none %}
                      <span class="badge text-bg-success">{{ dev.rssi }} %</span>
                    {% else %}
                      -
                    {% endif %}
                  </td>
                    <td>
                      {% if dev.power and dev.power|string|upper == 'ON' %}
                        <span class="badge text-bg-success">ON</span>
                      {% elif dev.power and dev.power|string|upper == 'OFF' %}
                        <span class="badge text-bg-danger">OFF</span>
                      {% else %}
                        {{ dev.power or '-' }}
                      {% endif %}
                    </td>
                  <td>
                    <a class="btn btn-outline-primary btn-sm" href="{{ dev.url }}" target="_blank" rel="noreferrer">
                      <i class="bi bi-box-arrow-up-right me-1"></i>Öffnen
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div id="devicesEmptyState" class="d-flex align-items-center gap-3 text-muted {% if devices %}d-none{% endif %}">
          <i class="bi bi-search fs-4"></i>
          <div>
            <div class="fw-semibold">Noch keine Geraete gefunden</div>
            <div class="small">Starte einen Scan über den Menüpunkt "Scan".</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script>
    (function() {
      const statusUrl = "{{ url_for('devices_refresh') }}";
      const devicesBody = document.getElementById('devicesTableBody');
      const devicesWrapper = document.getElementById('devicesTableWrapper');
      const devicesEmpty = document.getElementById('devicesEmptyState');
      const devicesBadge = document.getElementById('devicesCountBadge');
      const lastScanEl = document.getElementById('lastScanTime');
      const refreshMs = {{ refresh_interval_ms|int }};

      function renderDevices(devices) {
        if (!devicesBody) return;
        devicesBody.innerHTML = '';
        if (Array.isArray(devices) && devices.length > 0) {
          devices.forEach((dev) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>
                <div class="fw-semibold">${dev.name || 'Tasmota Geraet'}</div>
                <div class="text-muted small">${dev.hostname || dev.device_name || 'Hostname unbekannt'}</div>
              </td>
              <td>
                <a href="${dev.url}" target="_blank" rel="noreferrer" class="link-underline link-underline-opacity-0">
                  ${dev.ip}:${dev.port} (${(dev.protocol || '').toUpperCase()})
                </a>
              </td>
              <td>${dev.version || '-'}</td>
              <td class="text-monospace small">${dev.mac || '-'}</td>
              <td>${dev.rssi !== null && dev.rssi !== undefined ? `<span class="badge text-bg-success">${dev.rssi} %</span>` : '-'}</td>
              <td>
                ${(() => {
                  const p = (dev.power || '').toString().toUpperCase();
                  if (p === 'ON') return '<span class="badge text-bg-success">ON</span>';
                  if (p === 'OFF') return '<span class="badge text-bg-danger">OFF</span>';
                  return dev.power || '-';
                })()}
              </td>
              <td>
                <a class="btn btn-outline-primary btn-sm" href="${dev.url}" target="_blank" rel="noreferrer">
                  <i class="bi bi-box-arrow-up-right me-1"></i>Öffnen
                </a>
              </td>
            `;
            devicesBody.appendChild(tr);
          });
          if (devicesWrapper) devicesWrapper.style.display = '';
          if (devicesEmpty) devicesEmpty.classList.add('d-none');
        } else {
          if (devicesWrapper) devicesWrapper.style.display = 'none';
          if (devicesEmpty) devicesEmpty.classList.remove('d-none');
        }
        if (devicesBadge) devicesBadge.textContent = devices.length || 0;
      }

      function updateMeta(stats) {
        if (!lastScanEl) return;
        if (stats && stats.started_at) {
          const dt = new Date(stats.started_at);
          lastScanEl.textContent = `Letzter Scan: ${dt.toLocaleString()}`;
        } else {
          lastScanEl.textContent = 'Letzter Scan: noch keiner';
        }
      }

      function pollDevices() {
        fetch(statusUrl)
          .then((resp) => resp.json())
          .then((data) => {
            renderDevices(data.devices || []);
            updateMeta(data.stats || {});
          })
          .catch(() => {
            // ignore errors, retry later
          })
          .finally(() => {
            setTimeout(pollDevices, refreshMs);
          });
      }

      setTimeout(pollDevices, refreshMs);
    })();
  </script>
{% endblock %}
