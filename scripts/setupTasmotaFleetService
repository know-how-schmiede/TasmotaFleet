#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
default_install_dir="$(cd "${script_dir}/.." && pwd)"

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  cat <<'EOF'
Usage: setupTasmotaFleetService [options]

Options:
  --install-dir=PATH     Install directory (default: repo root)
  --venv-dir=PATH        Python venv path (default: <install-dir>/.venv)
  --service-user=USER    Service user (default: tasmotafleet)
  --service-name=NAME    systemd service name (default: tasmotafleet)
  --port=PORT            Listen port (default: 8080)
  --workers=N            Gunicorn workers (default: 2)
  --non-interactive      Use defaults for missing values (no prompts)
EOF
  exit 0
fi

if [[ "$(id -u)" -ne 0 ]]; then
  echo "ERROR: Run as root (sudo -i)."
  exit 1
fi

if ! command -v systemctl >/dev/null 2>&1; then
  echo "ERROR: systemctl not found. This container must use systemd."
  exit 1
fi

INSTALL_DIR=""
VENV_DIR=""
SERVICE_USER=""
SERVICE_NAME=""
PORT=""
WORKERS=""
NON_INTERACTIVE=0

for arg in "$@"; do
  case "$arg" in
    --install-dir=*)
      INSTALL_DIR="${arg#*=}"
      ;;
    --venv-dir=*)
      VENV_DIR="${arg#*=}"
      ;;
    --service-user=*)
      SERVICE_USER="${arg#*=}"
      ;;
    --service-name=*)
      SERVICE_NAME="${arg#*=}"
      ;;
    --port=*)
      PORT="${arg#*=}"
      ;;
    --workers=*)
      WORKERS="${arg#*=}"
      ;;
    --non-interactive)
      NON_INTERACTIVE=1
      ;;
    *)
      echo "Unknown option: $arg"
      exit 1
      ;;
  esac
done

prompt() {
  local label="$1"
  local default="$2"
  local value=""
  if [[ "$NON_INTERACTIVE" -eq 1 ]]; then
    printf '%s' "$default"
    return
  fi
  read -r -p "${label} [${default}]: " value
  if [[ -z "$value" ]]; then
    value="$default"
  fi
  printf '%s' "$value"
}

INSTALL_DIR="${INSTALL_DIR:-$(prompt "Install directory" "$default_install_dir")}"
VENV_DIR="${VENV_DIR:-$(prompt "Python venv path" "${INSTALL_DIR}/.venv")}"
SERVICE_USER="${SERVICE_USER:-$(prompt "Service user" "tasmotafleet")}"
SERVICE_NAME="${SERVICE_NAME:-$(prompt "Service name" "tasmotafleet")}"
PORT="${PORT:-$(prompt "Listen port" "8080")}"
WORKERS="${WORKERS:-$(prompt "Gunicorn workers" "2")}"

APP_FILE="${INSTALL_DIR}/src/app.py"
GUNICORN_BIN="${VENV_DIR}/bin/gunicorn"
PY_BIN="${VENV_DIR}/bin/python"

if [[ ! -f "$APP_FILE" ]]; then
  echo "ERROR: TasmotaFleet not found at ${APP_FILE}"
  exit 1
fi

if [[ ! -x "$PY_BIN" ]]; then
  echo "ERROR: Python venv not found at ${PY_BIN}"
  exit 1
fi

if ! id -u "$SERVICE_USER" >/dev/null 2>&1; then
  useradd -m -s /bin/bash "$SERVICE_USER"
fi

chown -R "${SERVICE_USER}:${SERVICE_USER}" "$INSTALL_DIR"

if [[ ! -x "$GUNICORN_BIN" ]]; then
  runuser -u "$SERVICE_USER" -- "$PY_BIN" -m pip install gunicorn
fi

SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"
cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=TasmotaFleet Service (Gunicorn)
After=network.target

[Service]
Type=simple
User=${SERVICE_USER}
Group=${SERVICE_USER}
WorkingDirectory=${INSTALL_DIR}
ExecStart=${GUNICORN_BIN} -w ${WORKERS} -b 0.0.0.0:${PORT} "src.app:create_app()"
Restart=always
RestartSec=2
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now "$SERVICE_NAME"

echo "Service installed and started: ${SERVICE_NAME}"
echo "Status: systemctl status ${SERVICE_NAME}"
